<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Loopback Benchmark</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .metric-value {
      font-variant-numeric: tabular-nums;
    }
  </style>
</head>

<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

  <div class="w-full max-w-2xl mx-auto p-8 bg-gray-800 rounded-2xl shadow-2xl border border-gray-700">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-cyan-400">WebSocket Loopback Benchmark</h1>
      <p class="text-gray-400 mt-2">Test the maximum data throughput to a local server.</p>
    </div>

    <div class="bg-gray-900 p-6 rounded-lg mb-6 border border-gray-700">
      <div class="flex justify-between items-center">
        <label for="ws-url" class="text-gray-300 font-medium">Server URL</label>
        <input type="text" id="ws-url" value="ws://localhost:8765"
          class="w-2/3 bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
      </div>
    </div>

    <div class="text-center mb-8">
      <button id="startBtn"
        class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg transition-all duration-300 transform hover:scale-105 shadow-lg disabled:bg-gray-600 disabled:cursor-not-allowed disabled:scale-100">
        Start Throughput Test
      </button>
    </div>

    <!-- Results Section -->
    <div id="results" class="bg-gray-900 p-6 rounded-lg border border-gray-700 space-y-4">
      <div>
        <h2 class="text-xl font-semibold text-gray-200 mb-2">Results</h2>
        <div id="status" class="text-lg text-gray-400">Awaiting test...</div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
        <div class="bg-gray-800 p-4 rounded-lg">
          <div class="text-sm text-gray-400">Bandwidth</div>
          <div id="bandwidth" class="text-3xl font-bold text-cyan-400 metric-value">0.00</div>
          <div class="text-sm text-gray-500">Gbps</div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg">
          <div class="text-sm text-gray-400">Data Sent</div>
          <div id="dataSent" class="text-3xl font-bold text-white metric-value">0</div>
          <div class="text-sm text-gray-500">MB</div>
        </div>
        <div class="bg-gray-800 p-4 rounded-lg">
          <div class="text-sm text-gray-400">Time Elapsed</div>
          <div id="time" class="text-3xl font-bold text-white metric-value">0.00</div>
          <div class="text-sm text-gray-500">Seconds</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const statusDiv = document.getElementById('status');
    const bandwidthDiv = document.getElementById('bandwidth');
    const dataSentDiv = document.getElementById('dataSent');
    const timeDiv = document.getElementById('time');
    const urlInput = document.getElementById('ws-url');

    let ws;
    let animationFrameId;

    function updateUI(status, bandwidth = 0, dataSent = 0, time = 0) {
      statusDiv.textContent = status;
      bandwidthDiv.textContent = bandwidth.toFixed(2);
      dataSentDiv.textContent = Math.round(dataSent);
      timeDiv.textContent = time.toFixed(2);
    }

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      const wsUrl = urlInput.value;
      updateUI('Connecting...');

      try {
        ws = new WebSocket(wsUrl);
      } catch (error) {
        updateUI(`Error: Invalid WebSocket URL. ${error.message}`);
        startBtn.disabled = false;
        return;
      }

      ws.onopen = () => {
        console.log('WebSocket connection opened.');
        runBenchmark();
      };

      ws.onerror = (error) => {
        console.error('WebSocket Error:', error);
        updateUI('Connection Error. Is the server running?');
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        startBtn.disabled = false;
      };

      ws.onclose = () => {
        console.log('WebSocket connection closed.');
        if (statusDiv.textContent.includes('Testing')) { // Only show finished if it was running
          updateUI('Test complete.');
        }
        startBtn.disabled = false;
      };
    });

    function runBenchmark() {
      // Configuration for the test
      const messageSize = 1024 * 1024; // 1 MB chunks
      const testDuration = 10000; // 10 seconds in milliseconds

      const data = new Uint8Array(messageSize); // Use binary for max performance
      let totalBytesSent = 0;
      const startTime = performance.now();

      function sendLoop(currentTime) {
        const elapsed = currentTime - startTime;

        if (elapsed >= testDuration) {
          const finalElapsedSeconds = elapsed / 1000;
          const gigabitsPerSecond = (totalBytesSent * 8) / (1e9) / finalElapsedSeconds;

          updateUI('Test finished.', gigabitsPerSecond, totalBytesSent / (1024 * 1024), finalElapsedSeconds);
          ws.close();
          return;
        }

        // Keep the send buffer from getting too backed up.
        // This gives a more realistic throughput measurement.
        while (ws.bufferedAmount < messageSize * 16 && ws.readyState === WebSocket.OPEN) {
          ws.send(data);
          totalBytesSent += messageSize;
        }

        // Update UI in real-time
        const elapsedSeconds = elapsed / 1000;
        const currentBandwidth = (totalBytesSent * 8) / (1e9) / elapsedSeconds;
        updateUI(`Testing... Buffer: ${(ws.bufferedAmount / 1024).toFixed(0)} KB`, currentBandwidth, totalBytesSent / (1024 * 1024), elapsedSeconds);

        animationFrameId = requestAnimationFrame(sendLoop);
      }

      animationFrameId = requestAnimationFrame(sendLoop);
    }
  </script>

</body>

</html>