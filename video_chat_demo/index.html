<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebRTC Demo with Diagnostics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .video-container {
      @apply bg-gray-900 rounded-lg overflow-hidden shadow-lg w-full aspect-video;
    }

    video {
      @apply w-full h-full object-cover;
    }

    .control-panel {
      @apply bg-gray-800 p-6 rounded-lg shadow-lg;
    }

    textarea {
      @apply w-full bg-gray-700 text-gray-200 rounded-md p-3 text-xs leading-relaxed border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all;
    }

    .btn {
      @apply w-full px-4 py-2 rounded-md font-semibold text-white transition-all duration-200 ease-in-out shadow-sm disabled:opacity-50 disabled:cursor-not-allowed;
    }

    .btn-primary {
      @apply bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-blue-500;
    }

    .btn-secondary {
      @apply bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-indigo-500;
    }

    .btn-success {
      @apply bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-green-500;
    }

    .btn-danger {
      @apply bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-red-500;
    }

    #statsBox {
      font-family: 'Fira Code', monospace;
      white-space: pre;
      background-color: #111827;
      /* bg-gray-900 */
      color: #9CA3AF;
      /* text-gray-400 */
      padding: 1rem;
      border-radius: 0.5rem;
      font-size: 0.8rem;
      line-height: 1.6;
    }
  </style>
</head>

<body class="bg-gray-900 text-gray-200">

  <div class="container mx-auto p-4 lg:p-8">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-bold text-white">WebRTC Demo with Diagnostics</h1>
      <p class="text-gray-400 mt-2">Stream video between two browser tabs and monitor the connection quality.</p>
    </header>

    <!-- Instructions -->
    <div class="bg-gray-800 border-l-4 border-blue-500 text-blue-100 p-4 rounded-r-lg mb-8" role="alert">
      <p class="font-bold mb-2">How to use this demo:</p>
      <ol class="list-decimal list-inside space-y-1 text-sm">
        <li>Open this page in two separate browser tabs (Tab A and Tab B).</li>
        <li>Click "1. Start Camera" on <span class="font-bold">both</span> tabs.</li>
        <li><span class="font-bold">On Tab A (Caller):</span> Click "2. Create Offer". An "Offer SDP" will be generated.
        </li>
        <li>Copy the entire Offer SDP from Tab A.</li>
        <li><span class="font-bold">On Tab B (Callee):</span> Paste the Offer SDP into the "Offer SDP" box.</li>
        <li><span class="font-bold">On Tab B:</span> Click "3. Create Answer". An "Answer SDP" will be generated.</li>
        <li>Copy the entire Answer SDP from Tab B.</li>
        <li><span class="font-bold">On Tab A:</span> Paste the Answer SDP into the "Answer SDP" box.</li>
        <li><span class="font-bold">On Tab A:</span> Click "4. Add Answer". The video streams should connect and
          diagnostics will appear.</li>
      </ol>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

      <!-- Videos and Diagnostics Section -->
      <div class="space-y-6">
        <div>
          <h2 class="text-2xl font-semibold mb-3 text-white">Local Video</h2>
          <div class="video-container">
            <video id="localVideo" autoplay playsinline muted></video>
          </div>
        </div>
        <div>
          <h2 class="text-2xl font-semibold mb-3 text-white">Remote Video</h2>
          <div class="video-container">
            <video id="remoteVideo" autoplay playsinline></video>
          </div>
        </div>
        <div>
          <h2 class="text-2xl font-semibold mb-3 text-white">Connection Diagnostics</h2>
          <div id="statsBox">Waiting for connection...</div>
        </div>
      </div>

      <!-- Controls and SDP Section -->
      <div class="control-panel space-y-6">
        <div>
          <h2 class="text-2xl font-semibold mb-4 text-white">Controls</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <button id="startBtn" class="btn btn-primary">1. Start Camera</button>
            <button id="offerBtn" class="btn btn-secondary" disabled>2. Create Offer</button>
            <button id="answerBtn" class="btn btn-success" disabled>3. Create Answer</button>
            <button id="addAnswerBtn" class="btn btn-success" disabled>4. Add Answer</button>
            <button id="hangupBtn" class="btn btn-danger col-span-1 sm:col-span-2" disabled>Hang Up</button>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <label for="offerSDP" class="block mb-2 font-medium text-gray-300">Offer SDP</label>
            <textarea id="offerSDP" rows="5"
              placeholder="Step 3 (Caller): Offer SDP will appear here.&#10;Step 5 (Callee): Paste Offer SDP here."></textarea>
          </div>
          <div>
            <label for="answerSDP" class="block mb-2 font-medium text-gray-300">Answer SDP</label>
            <textarea id="answerSDP" rows="5"
              placeholder="Step 6 (Callee): Answer SDP will appear here.&#10;Step 8 (Caller): Paste Answer SDP here."></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // DOM Elements
    const startBtn = document.getElementById('startBtn');
    const offerBtn = document.getElementById('offerBtn');
    const answerBtn = document.getElementById('answerBtn');
    const addAnswerBtn = document.getElementById('addAnswerBtn');
    const hangupBtn = document.getElementById('hangupBtn');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const offerSDP = document.getElementById('offerSDP');
    const answerSDP = document.getElementById('answerSDP');
    const statsBox = document.getElementById('statsBox');

    // WebRTC Globals
    let localStream;
    let remoteStream;
    let peerConnection;
    let statsInterval;

    // Public STUN servers
    const servers = {
      iceServers: [
        {
          urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'],
        },
      ],
      iceCandidatePoolSize: 10,
    };

    // --- Stats Display ---
    async function displayStats() {
      if (!peerConnection) return;

      const stats = await peerConnection.getStats();
      let statsOutput = "Waiting for data...";

      stats.forEach(report => {
        // We are interested in the inbound video stream statistics
        if (report.type === 'inbound-rtp' && report.kind === 'video') {
          const qos = {
            resolution: `${report.frameWidth}x${report.frameHeight}`,
            fps: report.framesPerSecond || 0,
            latency: `N/A`, // Latency is in a different report
            jitter: `${(report.jitter * 1000).toFixed(2)} ms`,
            packetsLost: report.packetsLost || 0,
            bytesReceived: `${(report.bytesReceived / 1024 / 1024).toFixed(2)} MB`,
            codec: `N/A`, // Codec info is in a different report
          };

          // Find the associated remote-outbound-rtp to get latency
          const remoteOutbound = stats.get(report.remoteId);
          if (remoteOutbound) {
            qos.latency = `${(remoteOutbound.roundTripTime * 1000).toFixed(2)} ms`;
          }

          // Find the codec report
          const codec = stats.get(report.codecId);
          if (codec) {
            qos.codec = `${codec.mimeType.split('/')[1]} (${codec.payloadType})`;
          }

          statsOutput = `
  Resolution:    ${qos.resolution}
  FPS:           ${qos.fps}
  Latency:       ${qos.latency}
  Jitter:        ${qos.jitter}
  Packets Lost:  ${qos.packetsLost}
  Data Received: ${qos.bytesReceived}
  Video Codec:   ${qos.codec}
`;
        }
      });

      statsBox.textContent = statsOutput;
    }


    // --- 1. Start Camera ---
    startBtn.onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        startBtn.disabled = true;
        offerBtn.disabled = false;
        answerBtn.disabled = false;
        hangupBtn.disabled = false;
      } catch (error) {
        console.error("Error accessing media devices.", error);
        alert("Could not access your camera/microphone. Please check permissions.");
      }
    };

    // Helper function to create a peer connection
    const createPeerConnection = () => {
      peerConnection = new RTCPeerConnection(servers);

      remoteStream = new MediaStream();
      remoteVideo.srcObject = remoteStream;

      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });

      peerConnection.ontrack = event => {
        event.streams[0].getTracks().forEach(track => {
          remoteStream.addTrack(track);
        });
      };

      // Listen for connection state changes to start/stop stats
      peerConnection.onconnectionstatechange = () => {
        if (peerConnection.connectionState === 'connected') {
          if (statsInterval) clearInterval(statsInterval);
          statsInterval = setInterval(displayStats, 1000);
        } else if (['disconnected', 'failed', 'closed'].includes(peerConnection.connectionState)) {
          clearInterval(statsInterval);
          statsBox.textContent = 'Connection lost.';
        }
      };
    };

    // --- 2. Create Offer (Caller) ---
    offerBtn.onclick = async () => {
      createPeerConnection();
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          offerSDP.value = JSON.stringify(peerConnection.localDescription);
        }
      };
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      offerSDP.value = JSON.stringify(peerConnection.localDescription);
      addAnswerBtn.disabled = false;
      offerBtn.disabled = true;
      answerBtn.disabled = true;
    };

    // --- 3. Create Answer (Callee) ---
    answerBtn.onclick = async () => {
      createPeerConnection();
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          answerSDP.value = JSON.stringify(peerConnection.localDescription);
        }
      };
      const offer = JSON.parse(offerSDP.value);
      await peerConnection.setRemoteDescription(offer);
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      answerSDP.value = JSON.stringify(peerConnection.localDescription);
      offerBtn.disabled = true;
      answerBtn.disabled = true;
    };

    // --- 4. Add Answer (Caller) ---
    addAnswerBtn.onclick = async () => {
      if (!peerConnection) return console.error('PeerConnection does not exist!');
      if (!answerSDP.value) return alert('Please paste the Answer SDP first.');

      const answer = JSON.parse(answerSDP.value);
      if (!peerConnection.currentRemoteDescription) {
        await peerConnection.setRemoteDescription(answer);
      }
      addAnswerBtn.disabled = true;
    };

    // --- Hang Up ---
    hangupBtn.onclick = () => {
      clearInterval(statsInterval);
      if (localStream) localStream.getTracks().forEach(track => track.stop());
      if (remoteStream) remoteStream.getTracks().forEach(track => track.stop());
      if (peerConnection) peerConnection.close();

      localVideo.srcObject = null;
      remoteVideo.srcObject = null;
      startBtn.disabled = false;
      offerBtn.disabled = true;
      answerBtn.disabled = true;
      addAnswerBtn.disabled = true;
      hangupBtn.disabled = true;
      offerSDP.value = '';
      answerSDP.value = '';
      statsBox.textContent = 'Connection closed.';
    };
  </script>
</body>

</html>