<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raw Bitmap Stream over WebSocket</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        canvas {
            /* Ensures canvas doesn't get distorted by CSS resizing */
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-5xl bg-gray-800 rounded-2xl shadow-lg p-6 space-y-6">

        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-white">Raw Bitmap Streaming PoC</h1>
            <p class="text-gray-400 mt-2">Streaming raw RGBA data from a Python server via WebSockets.</p>
        </div>

        <!-- Controls -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 p-4 bg-gray-900/50 rounded-lg">
            <div class="w-full sm:w-auto">
                <label for="resolution" class="block text-sm font-medium text-gray-300 mb-1">Resolution</label>
                <select id="resolution" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option>HD (1280x720)</option>
                    <option>FHD (1920x1080)</option>
                    <option>4K (3840x2160)</option>
                </select>
            </div>
            <button id="startButton" class="w-full sm:w-auto mt-2 sm:mt-5 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Start Stream</button>
            <button id="stopButton" class="w-full sm:w-auto mt-2 sm:mt-5 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 hidden">Stop Stream</button>
        </div>

        <!-- Status & Performance -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
            <div class="bg-gray-700 p-3 rounded-lg">
                <h3 class="text-sm font-semibold text-gray-400">Status</h3>
                <p id="status" class="text-lg font-mono font-semibold text-yellow-400">Idle</p>
            </div>
            <div class="bg-gray-700 p-3 rounded-lg">
                <h3 class="text-sm font-semibold text-gray-400">Frames Per Second</h3>
                <p id="fps" class="text-lg font-mono font-semibold text-green-400">0</p>
            </div>
             <div class="bg-gray-700 p-3 rounded-lg">
                <h3 class="text-sm font-semibold text-gray-400">Data Rate</h3>
                <p id="dataRate" class="text-lg font-mono font-semibold text-cyan-400">0 MB/s</p>
            </div>
        </div>

        <!-- Video Display -->
        <div class="bg-black rounded-lg overflow-hidden aspect-video w-full">
            <canvas id="videoCanvas" class="w-full h-full"></canvas>
        </div>

    </div>

    <script>
        // --- DOM Element References ---
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const resolutionSelect = document.getElementById('resolution');
        const statusEl = document.getElementById('status');
        const fpsEl = document.getElementById('fps');
        const dataRateEl = document.getElementById('dataRate');
        const canvas = document.getElementById('videoCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); // alpha: false can improve performance

        // --- State Management ---
        let websocket = null;
        const WS_URL = 'ws://localhost:8765';
        let isStreaming = false;

        // --- Performance Metrics ---
        let frameCount = 0;
        let lastTime = performance.now();
        let totalBytesReceived = 0;


        const resolutionMap = {
            "HD (1280x720)": { width: 1280, height: 720 },
            "FHD (1920x1080)": { width: 1920, height: 1080 },
            "4K (3840x2160)": { width: 3840, height: 2160 }
        };

        // --- Functions ---

        function updateUI(streaming) {
            isStreaming = streaming;
            startButton.classList.toggle('hidden', streaming);
            resolutionSelect.disabled = streaming;
            stopButton.classList.toggle('hidden', !streaming);
        }

        function updateStatus(message, colorClass) {
            statusEl.textContent = message;
            statusEl.className = `text-lg font-mono font-semibold ${colorClass}`;
        }

        function calculatePerformance(frameSize) {
            const now = performance.now();
            const delta = now - lastTime;
            frameCount++;
            totalBytesReceived += frameSize;

            if (delta >= 1000) { // Update every second
                const fps = ((frameCount * 1000) / delta).toFixed(1);
                const dataRate = (totalBytesReceived / (1024 * 1024) / (delta / 1000)).toFixed(2);

                fpsEl.textContent = fps;
                dataRateEl.textContent = `${dataRate} MB/s`;

                // Reset for next interval
                lastTime = now;
                frameCount = 0;
                totalBytesReceived = 0;
            }
        }

        function startStream() {
            if (websocket) {
                console.warn("WebSocket is already open.");
                return;
            }

            const selectedResolution = resolutionSelect.value;
            const { width, height } = resolutionMap[selectedResolution];

            // Set canvas resolution to match stream
            canvas.width = width;
            canvas.height = height;

            updateStatus('Connecting...', 'text-blue-400');

            websocket = new WebSocket(WS_URL);
            websocket.binaryType = 'arraybuffer'; // Crucial for performance

            websocket.onopen = () => {
                console.log('WebSocket connection established.');
                updateStatus('Streaming', 'text-green-400');
                updateUI(true);

                // Send start command to server
                const startMessage = {
                    action: 'start',
                    resolution: selectedResolution
                };
                websocket.send(JSON.stringify(startMessage));

                // Reset performance counters
                lastTime = performance.now();
                frameCount = 0;
                totalBytesReceived = 0;
            };

            websocket.onmessage = (event) => {
                // event.data is an ArrayBuffer
                if (event.data instanceof ArrayBuffer) {
                    try {
                        // Create a view of the buffer that matches the RGBA pixel format
                        const pixelData = new Uint8ClampedArray(event.data);

                        // Create an ImageData object from the raw pixel data
                        const imageData = new ImageData(pixelData, width, height);

                        // Draw the ImageData onto the canvas
                        // Using createImageBitmap can be faster on some browsers
                        createImageBitmap(imageData).then(bitmap => {
                            ctx.drawImage(bitmap, 0, 0);
                        });

                        // Update performance metrics
                        calculatePerformance(event.data.byteLength);

                    } catch(e) {
                        console.error("Error processing frame:", e);
                        stopStream();
                    }
                }
            };

            websocket.onclose = (event) => {
                console.log(`WebSocket closed: Code ${event.code}, Reason: ${event.reason}`);
                updateStatus('Disconnected', 'text-red-400');
                updateUI(false);
                websocket = null;
            };

            websocket.onerror = (error) => {
                console.error('WebSocket Error:', error);
                updateStatus('Error', 'text-red-500');
                updateUI(false);
                websocket = null; // Ensure we clean up
            };
        }

        function stopStream() {
            if (websocket) {
                websocket.close();
                // The onclose handler will reset the UI and state
            }
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', startStream);
        stopButton.addEventListener('click', stopStream);

    </script>
</body>
</html>
